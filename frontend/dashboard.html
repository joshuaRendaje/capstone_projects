<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Futuristic Water Quality Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #0f2027, #2c5364);
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      margin: 0;
      color: #f4f6fa;
    }

    .layout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 220px;
      background: linear-gradient(135deg, #232526 60%, #414345 100%);
      box-shadow: 2px 0 12px #222;
      padding: 32px 0 0 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .sidebar h2 {
      color: #00c6ff;
      font-size: 1.3em;
      margin-bottom: 32px;
      letter-spacing: 2px;
    }

    .sidebar nav {
      width: 100%;
    }

    .sidebar nav a {
      display: block;
      color: #f4f6fa;
      text-decoration: none;
      padding: 14px 32px;
      margin-bottom: 8px;
      border-radius: 8px 0 0 8px;
      transition: background 0.2s;
      font-size: 1.1em;
    }

    .sidebar nav a.active,
    .sidebar nav a:hover {
      background: #00c6ff33;
      color: #00c6ff;
    }

    .container {
      flex: 1;
      max-width: 900px;
      margin: 40px auto;
      padding: 24px;
      background: rgba(30, 40, 60, 0.85);
      border-radius: 18px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    }

    h1 {
      text-align: center;
      font-size: 2.4em;
      letter-spacing: 2px;
      margin-bottom: 32px;
      color: #00c6ff;
      text-shadow: 0 2px 8px #222;
    }

    .graph-section {
      background: rgba(44, 83, 100, 0.7);
      border-radius: 14px;
      padding: 18px;
      margin-bottom: 32px;
      box-shadow: 0 2px 8px #222;
    }

    .graph-title {
      text-align: center;
      font-size: 1.3em;
      color: #00c6ff;
      margin-bottom: 12px;
    }

    .pia-row {
      display: flex;
      gap: 32px;
      justify-content: center;
      align-items: center;
      margin-bottom: 32px;
    }

    .pia-container {
      flex: 1 1 200px;
      text-align: center;
      background: linear-gradient(135deg, #232526 60%, #414345 100%);
      border-radius: 12px;
      padding: 22px;
      box-shadow: 0 2px 8px #222;
      margin: 0 8px;
    }

    .pia-label {
      margin-top: 10px;
      color: #00c6ff;
      font-size: 1.1em;
      font-weight: bold;
      letter-spacing: 1px;
    }

    .pia-level {
      color: #00ffb4;
      font-size: 1em;
      margin-top: 6px;
    }

    .pia-value {
      color: #fff;
      font-size: 1.3em;
      margin-top: 6px;
    }

    .pia-timestamp {
      color: #b2bec3;
      font-size: 0.95em;
      margin-top: 6px;
    }

    #realtime-reading {
      font-size: 1.2em;
      color: #00c6ff;
      background: rgba(44, 83, 100, 0.2);
      padding: 8px 18px;
      border-radius: 8px;
      display: inline-block;
      margin-top: 18px;
    }

    @media (max-width: 900px) {
      .layout {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        flex-direction: row;
        padding: 0;
        justify-content: center;
      }

      .sidebar nav {
        display: flex;
      }

      .sidebar nav a {
        margin-bottom: 0;
        margin-right: 8px;
        border-radius: 8px;
        padding: 14px 18px;
      }

      .container {
        margin: 20px auto;
      }

      .pia-row {
        flex-direction: column;
        gap: 18px;
      }
    }

    @media (max-width: 700px) {
      .container {
        padding: 8px;
      }

      .pia-row {
        flex-direction: column;
      }

      .pia-container {
        margin-bottom: 12px;
      }
    }
  </style>
</head>

<body>
  <div class="layout">
    <aside class="sidebar">
      <h2>Oyster AI</h2>
      <nav>
        <a href="#" class="active" id="dashboard-link">Dashboard</a>
        <a href="#" id="statistics-link">Statistics</a>
        <a href="#">Settings</a>
        <a href="#">About</a>
      </nav>
    </aside>
    <main class="container">
      <h1>Water Quality Monitoring Dashboard</h1>
      <div id="dashboard-content">
        <div class="graph-section">
          <div class="graph-title">Realtime Water Quality Graph</div>
          <canvas id="waterChart" height="120"></canvas>
          <div style="text-align:center;">
            <span id="realtime-reading">Loading latest reading...</span>
          </div>
        </div>
        <div class="pia-row">
          <div class="pia-container">
            <canvas id="turbidityPie" width="120" height="120"></canvas>
            <div class="pia-label">Turbidity (NTU)</div>
            <div class="pia-level" id="turbidity-level"></div>
            <div class="pia-value" id="turbidity-pia"></div>
            <div class="pia-timestamp" id="turbidity-time"></div>
          </div>
          <div class="pia-container">
            <canvas id="doPie" width="120" height="120"></canvas>
            <div class="pia-label">Dissolved Oxygen (mg/L)</div>
            <div class="pia-level" id="do-level"></div>
            <div class="pia-value" id="do-pia"></div>
            <div class="pia-timestamp" id="do-time"></div>
          </div>
          <div class="pia-container">
            <canvas id="tempPie" width="120" height="120"></canvas>
            <div class="pia-label">Temperature (°C)</div>
            <div class="pia-level" id="temp-level"></div>
            <div class="pia-value" id="temp-pia"></div>
            <div class="pia-timestamp" id="temp-time"></div>
          </div>
        </div>
      </div>
      <div id="statistics-content" style="display:none;">
        <div class="graph-section">
          <div class="graph-title">Sensor Statistics (PIA Pie Charts)</div>
          <div class="pia-row">
            <div class="pia-container">
              <canvas id="statTurbidityPie" width="120" height="120"></canvas>
              <div class="pia-label">Turbidity (NTU)</div>
              <div class="pia-level" id="stat-turbidity-level"></div>
              <div class="pia-value" id="stat-turbidity-pia"></div>
              <div class="pia-timestamp" id="stat-turbidity-time"></div>
            </div>
            <div class="pia-container">
              <canvas id="statDoPie" width="120" height="120"></canvas>
              <div class="pia-label">Dissolved Oxygen (mg/L)</div>
              <div class="pia-level" id="stat-do-level"></div>
              <div class="pia-value" id="stat-do-pia"></div>
              <div class="pia-timestamp" id="stat-do-time"></div>
            </div>
            <div class="pia-container">
              <canvas id="statTempPie" width="120" height="120"></canvas>
              <div class="pia-label">Temperature (°C)</div>
              <div class="pia-level" id="stat-temp-level"></div>
              <div class="pia-value" id="stat-temp-pia"></div>
              <div class="pia-timestamp" id="stat-temp-time"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script>
    // Chart.js setup for line graph
    const ctx = document.getElementById('waterChart').getContext('2d');
    const waterChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Turbidity',
          data: [],
          borderColor: '#00c6ff',
          backgroundColor: 'rgba(0,198,255,0.1)',
          tension: 0.3,
          pointRadius: 2,
          fill: false
        },
        {
          label: 'Dissolved Oxygen',
          data: [],
          borderColor: '#00ffb4',
          backgroundColor: 'rgba(0,255,180,0.1)',
          tension: 0.3,
          pointRadius: 2,
          fill: false
        },
        {
          label: 'Temperature',
          data: [],
          borderColor: '#ff6e40',
          backgroundColor: 'rgba(255,110,64,0.1)',
          tension: 0.3,
          pointRadius: 2,
          fill: false
        }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            labels: {
              color: '#fff'
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#fff'
            },
            title: {
              display: true,
              text: 'Time',
              color: '#00c6ff'
            }
          },
          y: {
            ticks: {
              color: '#fff'
            },
            title: {
              display: true,
              text: 'Value',
              color: '#00c6ff'
            }
          }
        }
      }
    });

    function getLevel(sensor, value) {
      if (sensor === "turbidity") {
        if (value < 5) return "Low";
        if (value < 50) return "Moderate";
        return "High";
      }
      if (sensor === "do") {
        if (value < 3) return "Low";
        if (value < 7) return "Moderate";
        return "High";
      }
      if (sensor === "temp") {
        if (value < 20) return "Low";
        if (value < 30) return "Moderate";
        return "High";
      }
      return "--";
    }

    function getPIA(sensor, value) {
      if (sensor === "turbidity") return Math.round((value / 100) * 100) + "%";
      if (sensor === "do") return Math.round((value / 14) * 100) + "%";
      if (sensor === "temp") return Math.round((value / 40) * 100) + "%";
      return "--";
    }

    function updatePieChart(chart, value, max, color) {
      // Show percentage in the center using Chart.js plugin
      chart.data.datasets[0].data = [value, Math.max(0, max - value)];
      chart.data.datasets[0].backgroundColor = [color, "#222"];
      chart.options.plugins = chart.options.plugins || {};
      chart.options.plugins.tooltip = {
        enabled: true
      };
      chart.options.plugins.datalabels = {
        display: true,
        color: '#fff',
        font: {
          weight: 'bold',
          size: 16
        },
        formatter: function (val, ctx) {
          if (ctx.dataIndex === 0) {
            return Math.round((value / max) * 100) + '%';
          }
          return '';
        }
      };
      chart.update();
    }

    // Dashboard PIA charts
    const turbidityPieCtx = document.getElementById('turbidityPie').getContext('2d');
    const doPieCtx = document.getElementById('doPie').getContext('2d');
    const tempPieCtx = document.getElementById('tempPie').getContext('2d');
    let turbidityPie, doPie, tempPie;

    // Statistics PIA charts
    const statTurbidityPieCtx = document.getElementById('statTurbidityPie').getContext('2d');
    const statDoPieCtx = document.getElementById('statDoPie').getContext('2d');
    const statTempPieCtx = document.getElementById('statTempPie').getContext('2d');
    let statTurbidityPie, statDoPie, statTempPie;

    async function fetchReadings() {
      try {
        // FIX: Use /all-readings endpoint for GET
        const response = await fetch('http://localhost:8000/all-readings');
        const data = await response.json();
        if (Array.isArray(data) && data.length > 0) {
          const latest = data[data.length - 1];

          // Realtime reading display
          document.getElementById('realtime-reading').innerHTML =
            `<b>Latest:</b> Turbidity: <span style="color:#00c6ff">${latest.turbidity_NTU ?? '--'}</span> NTU, ` +
            `DO: <span style="color:#00ffb4">${latest.dissolved_oxygen_mgL ?? '--'}</span> mg/L, ` +
            `Temp: <span style="color:#ff6e40">${latest.temperature_C ?? '--'}</span> °C ` +
            `<span style="color:#b2bec3">(${latest.timestamp ?? ''})</span>`;

          // Update dashboard PIA charts
          if (!turbidityPie) {
            turbidityPie = new Chart(turbidityPieCtx, {
              type: 'doughnut',
              data: {
                labels: ['Turbidity', 'Remaining'],
                datasets: [{
                  data: [latest.turbidity_NTU ?? 0, Math.max(0, 100 - (latest.turbidity_NTU ?? 0))],
                  backgroundColor: ['#00c6ff', '#222']
                }]
              },
              options: {
                plugins: {
                  legend: {
                    labels: {
                      color: '#fff'
                    }
                  }
                }
              }
            });
          } else {
            updatePieChart(turbidityPie, latest.turbidity_NTU ?? 0, 100, '#00c6ff');
          }
          document.getElementById('turbidity-level').innerText = "Level: " + getLevel("turbidity", latest.turbidity_NTU ?? 0);
          document.getElementById('turbidity-pia').innerText = "PIA: " + getPIA("turbidity", latest.turbidity_NTU ?? 0);
          document.getElementById('turbidity-time').innerText = latest.timestamp ?? '';

          if (!doPie) {
            doPie = new Chart(doPieCtx, {
              type: 'doughnut',
              data: {
                labels: ['DO', 'Remaining'],
                datasets: [{
                  data: [latest.dissolved_oxygen_mgL ?? 0, Math.max(0, 14 - (latest.dissolved_oxygen_mgL ?? 0))],
                  backgroundColor: ['#00ffb4', '#222']
                }]
              },
              options: {
                plugins: {
                  legend: {
                    labels: {
                      color: '#fff'
                    }
                  }
                }
              }
            });
          } else {
            updatePieChart(doPie, latest.dissolved_oxygen_mgL ?? 0, 14, '#00ffb4');
          }
          document.getElementById('do-level').innerText = "Level: " + getLevel("do", latest.dissolved_oxygen_mgL ?? 0);
          document.getElementById('do-pia').innerText = "PIA: " + getPIA("do", latest.dissolved_oxygen_mgL ?? 0);
          document.getElementById('do-time').innerText = latest.timestamp ?? '';

          if (!tempPie) {
            tempPie = new Chart(tempPieCtx, {
              type: 'doughnut',
              data: {
                labels: ['Temperature', 'Remaining'],
                datasets: [{
                  data: [latest.temperature_C ?? 0, Math.max(0, 40 - (latest.temperature_C ?? 0))],
                  backgroundColor: ['#ff6e40', '#222']
                }]
              },
              options: {
                plugins: {
                  legend: {
                    labels: {
                      color: '#fff'
                    }
                  }
                }
              }
            });
          } else {
            updatePieChart(tempPie, latest.temperature_C ?? 0, 40, '#ff6e40');
          }
          document.getElementById('temp-level').innerText = "Level: " + getLevel("temp", latest.temperature_C ?? 0);
          document.getElementById('temp-pia').innerText = "PIA: " + getPIA("temp", latest.temperature_C ?? 0);
          document.getElementById('temp-time').innerText = latest.timestamp ?? '';

          // Update graph
          const labels = data.map(r => r.timestamp ?? '');
          waterChart.data.labels = labels;
          waterChart.data.datasets[0].data = data.map(r => r.turbidity_NTU ?? null);
          waterChart.data.datasets[1].data = data.map(r => r.dissolved_oxygen_mgL ?? null);
          waterChart.data.datasets[2].data = data.map(r => r.temperature_C ?? null);
          waterChart.update();
        }
      } catch (e) {
        document.getElementById('realtime-reading').innerText = 'Error loading latest reading';
        document.getElementById('turbidity-level').innerText = 'Error';
        document.getElementById('do-level').innerText = 'Error';
        document.getElementById('temp-level').innerText = 'Error';
      }
    }

    async function fetchStatistics() {
      try {
        const response = await fetch('http://localhost:8000/all-readings');
        const data = await response.json();
        if (Array.isArray(data) && data.length > 0) {
          const latest = data[data.length - 1];
          // Turbidity Pie
          if (!statTurbidityPie) {
            statTurbidityPie = new Chart(statTurbidityPieCtx, {
              type: 'doughnut',
              data: {
                labels: ['Turbidity', 'Remaining'],
                datasets: [{
                  data: [latest.turbidity_NTU ?? 0, Math.max(0, 100 - (latest.turbidity_NTU ?? 0))],
                  backgroundColor: ['#00c6ff', '#222']
                }]
              },
              options: {
                plugins: {
                  legend: {
                    labels: {
                      color: '#fff'
                    }
                  }
                }
              }
            });
          } else {
            updatePieChart(statTurbidityPie, latest.turbidity_NTU ?? 0, 100, '#00c6ff');
          }
          document.getElementById('stat-turbidity-level').innerText = "Level: " + getLevel("turbidity", latest.turbidity_NTU ?? 0);
          document.getElementById('stat-turbidity-pia').innerText = "PIA: " + getPIA("turbidity", latest.turbidity_NTU ?? 0);
          document.getElementById('stat-turbidity-time').innerText = latest.timestamp ?? '';

          // DO Pie
          if (!statDoPie) {
            statDoPie = new Chart(statDoPieCtx, {
              type: 'doughnut',
              data: {
                labels: ['DO', 'Remaining'],
                datasets: [{
                  data: [latest.dissolved_oxygen_mgL ?? 0, Math.max(0, 14 - (latest.dissolved_oxygen_mgL ?? 0))],
                  backgroundColor: ['#00ffb4', '#222']
                }]
              },
              options: {
                plugins: {
                  legend: {
                    labels: {
                      color: '#fff'
                    }
                  }
                }
              }
            });
          } else {
            updatePieChart(statDoPie, latest.dissolved_oxygen_mgL ?? 0, 14, '#00ffb4');
          }
          document.getElementById('stat-do-level').innerText = "Level: " + getLevel("do", latest.dissolved_oxygen_mgL ?? 0);
          document.getElementById('stat-do-pia').innerText = "PIA: " + getPIA("do", latest.dissolved_oxygen_mgL ?? 0);
          document.getElementById('stat-do-time').innerText = latest.timestamp ?? '';

          // Temp Pie
          if (!statTempPie) {
            statTempPie = new Chart(statTempPieCtx, {
              type: 'doughnut',
              data: {
                labels: ['Temperature', 'Remaining'],
                datasets: [{
                  data: [latest.temperature_C ?? 0, Math.max(0, 40 - (latest.temperature_C ?? 0))],
                  backgroundColor: ['#ff6e40', '#222']
                }]
              },
              options: {
                plugins: {
                  legend: {
                    labels: {
                      color: '#fff'
                    }
                  }
                }
              }
            });
          } else {
            updatePieChart(statTempPie, latest.temperature_C ?? 0, 40, '#ff6e40');
          }
          document.getElementById('stat-temp-level').innerText = "Level: " + getLevel("temp", latest.temperature_C ?? 0);
          document.getElementById('stat-temp-pia').innerText = "PIA: " + getPIA("temp", latest.temperature_C ?? 0);
          document.getElementById('stat-temp-time').innerText = latest.timestamp ?? '';
        }
      } catch (e) {
        document.getElementById('stat-turbidity-level').innerText = 'Error';
        document.getElementById('stat-do-level').innerText = 'Error';
        document.getElementById('stat-temp-level').innerText = 'Error';
      }
    }

    // Sidebar navigation logic
    document.getElementById('dashboard-link').onclick = function () {
      document.getElementById('dashboard-content').style.display = '';
      document.getElementById('statistics-content').style.display = 'none';
      this.classList.add('active');
      document.getElementById('statistics-link').classList.remove('active');
    };
    document.getElementById('statistics-link').onclick = function () {
      document.getElementById('dashboard-content').style.display = 'none';
      document.getElementById('statistics-content').style.display = '';
      this.classList.add('active');
      document.getElementById('dashboard-link').classList.remove('active');
      fetchStatistics();
    };

    setInterval(fetchReadings, 2000);
    fetchReadings();
  </script>
</body>

</html>