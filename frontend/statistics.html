<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oyster Monitoring Statistics</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: white;
      font-family: 'Inter', sans-serif;
    }
    .glass-card {
      background: rgba(30, 41, 59, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 1rem;
      box-shadow: 0 6px 20px rgba(0,0,0,0.6);
    }
  
  #dataTable td {
    text-align: center;
  }
  #dataTable th {
    text-align: center;
  }

  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Navbar -->
  <header class="flex justify-between items-center px-4 sm:px-6 py-3 sm:py-4 bg-gray-900 bg-opacity-70 backdrop-blur-md sticky top-0 z-50">
    <h1 class="text-lg sm:text-2xl font-extrabold bg-gradient-to-r from-purple-400 via-pink-400 to-red-400 bg-clip-text text-transparent">
      Oyster Monitoring Statistics
    </h1>
    <div class="relative">
      <button onclick="toggleMenu()" class="text-white focus:outline-none">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 sm:h-8 sm:w-8" fill="none"
             viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <div id="menu" class="hidden absolute right-0 mt-2 w-40 sm:w-48 bg-gray-800 rounded-lg shadow-lg border border-gray-700">
        <a href="index1.html" class="block px-3 sm:px-4 py-2 hover:bg-gray-700">üìä Dashboard</a>
        <a href="statistics.html" class="block px-3 sm:px-4 py-2 hover:bg-gray-700">üìà Statistics</a>
      </div>
    </div>
  </header>

  <!-- Table Section -->
  <main class="flex-1 p-4 sm:p-6">
    <div class="glass-card p-4 sm:p-6">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
        <h2 class="text-base sm:text-lg font-semibold text-gray-300">üìã Sensor Readings</h2>
        <div class="flex flex-wrap sm:flex-nowrap items-center gap-3 sm:gap-4">
          <select id="filterSelect" class="bg-gray-800 border border-gray-700 text-white px-2 sm:px-3 py-2 rounded-lg text-sm sm:text-base">
            <option value="24h">Last 24h</option>
            <option value="7d">Last 7 Days</option>
            <option value="all" selected>All Records</option>
          </select>
          <button onclick="downloadCSV()" class="bg-green-500 hover:bg-green-600 text-white px-3 sm:px-4 py-2 rounded-lg shadow text-sm sm:text-base">
            ‚¨áÔ∏è Export CSV
          </button>
        </div>
      </div>

      <!-- Scrollable Table -->
      <div class="overflow-x-auto max-h-[400px] sm:max-h-[600px] overflow-y-auto cursor-pointer">
        <table class="min-w-full text-xs sm:text-sm border border-gray-700 text-gray-200">
          <thead class="bg-blue-900 text-white-300 sticky top-0 text-xs sm:text-sm">
            <tr>
              <th class="px-2 sm:px-4 py-2 border border-gray-600">Timestamp</th>
              <th class="px-2 sm:px-4 py-2 border border-gray-600">Temp (¬∞C)</th>
               <th class="px-2 sm:px-4 py-2 border border-gray-600">Temperature_level</th>
              <th class="px-2 sm:px-4 py-2 border border-gray-600">TDS</th>
               <th class="px-2 sm:px-4 py-2 border border-gray-600">Tds_level</th>
              <th class="px-2 sm:px-4 py-2 border border-gray-600">Turbidity (NTU)</th>
               <th class="px-2 sm:px-4 py-2 border border-gray-600">Turbidity_level</th>
              <th class="px-2 sm:px-4 py-2 border border-gray-600">Salinity</th>
               <th class="px-2 sm:px-4 py-2 border border-gray-600">Salinity_level</th>
              <th class="px-2 sm:px-4 py-2 border border-gray-600">pH</th>
               <th class="px-2 sm:px-4 py-2 border border-gray-600">PH_level</th>
            </tr>
          </thead>
          <tbody id="dataTable"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 bg-opacity-70 text-center p-2 sm:p-3 text-xs sm:text-sm text-gray-400">
    Oyster Monitoring System ¬© 2025
  </footer>

  <!-- Script Section -->
 <script>
  function toggleMenu() {
    document.getElementById("menu").classList.toggle("hidden");
  }

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCjTkCAgC8l9PUiFIeWXpy2S2nH7foJHX8",
    authDomain: "trial-reading.firebaseapp.com",
    databaseURL: "https://trial-reading-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "trial-reading",
    storageBucket: "trial-reading.firebasestorage.app",
    messagingSenderId: "541548808372",
    appId: "1:541548808372:web:773b8f8cac50b0e4c2afe1"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const ref = db.ref("trial1_Reading");

  let allData = [];
  const ROW_LIMIT = 100; // max rows to render

  // Convert turbidity voltage to NTU
  function voltageToNTU(voltage) {
    return Math.round(300 * (3.3 - voltage));
  }

  // Listen for realtime updates
  ref.on("value", snapshot => {
    const data = [];
    snapshot.forEach(child => {
      const val = child.val();
      if (!val.timestamp) return;

      const dateObj = new Date(val.timestamp.replace(" ", "T"));
      if (isNaN(dateObj)) return;

      val._date = dateObj;

      if (val.turbidity_voltage && !val.turbidity_ntu) {
        val.turbidity_ntu = voltageToNTU(val.turbidity_voltage);
      }

      data.push(val);
    });

    allData = data.sort((a, b) => a._date - b._date);
    applyFilter();
  });

  function applyFilter() {
    const filter = document.getElementById("filterSelect").value;
    const now = new Date();
    let filtered = [...allData];

    if (filter === "24h") {
      filtered = filtered.filter(d => now - d._date <= 24 * 60 * 60 * 1000);
    } else if (filter === "7d") {
      filtered = filtered.filter(d => now - d._date <= 7 * 24 * 60 * 60 * 1000);
    }

    renderTable(filtered.reverse()); // newest first
  }

  document.getElementById("filterSelect").addEventListener("change", applyFilter);

  function renderTable(data) {
    const tbody = document.getElementById("dataTable");
    tbody.innerHTML = "";

    if (!data.length) {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No data found</td></tr>`;
      return;
    }

    // Limit rows for performance
    const limited = data.slice(0, ROW_LIMIT);

    let rows = "";
    limited.forEach(d => {
      rows += `
        <tr class="hover:bg-gray-900 transition-colors cursor-pointer">
          <td class="px-2 sm:px-4 py-2 border-2 border-green-700 text-center">${d.timestamp}</td>
          <td class="px-5 sm:px-4 py-2 border-2 border-green-700 text-center">${d.temperature ?? "--"}</td>
          <td class="px-2 sm:px-4 py-2 border-2 border-green-700 text-center">${d.temperature_level ?? "--"}</td>
          <td class="px-2 sm:px-4 py-2 border-2 border-green-700 text-center">${d.tds ?? "--"}</td>
          <td class="px-2 sm:px-4 py-2 border-2 border-green-700 text-center">${d.tds_level ?? "--"}</td>
          <td class="px-2 sm:px-4 py-2 border-2 border-green-700 text-center">${d.turbidity_ntu ?? "--"}</td>
          <td class="px-2 sm:px-4 py-2 border-2 border-green-700 text-center">${d.turbidity_level ?? "--"}</td>
          <td class="px-2 sm:px-4 py-2 border-2 border-green-700 text-center">${d.salinity ?? "--"}</td>
          <td class="px-2 sm:px-4 py-2 border-2 border-green-700 text-center">${d.salinity_level ?? "--"}</td>
          <td class="px-2 sm:px-4 py-2 border-2 border-green-700 text-center">${d.ph ?? "--"}</td>
          <td class="px-2 sm:px-4 py-2 border-2 border-green-700 text-center">${d.ph_level ?? "--"}</td>
        </tr>
      `;
    });

    tbody.innerHTML = rows;

    // Show message if limited
    if (data.length > ROW_LIMIT) {
      tbody.innerHTML += `
        <tr>
          <td colspan="6" class="text-center py-2 text-gray-400">
            Showing latest ${ROW_LIMIT} of ${data.length} records
          </td>
        </tr>
      `;
    }
  }

  function downloadCSV() {
    const rows = [["Timestamp","Temp","temp_level", "TDS","tds_level", "Turbidity (NTU)","Turbidity_level" ,"Salinity", "salinity_level", "pH", "ph_level"]];
    allData.forEach(d => {
      rows.push([
        d.timestamp || "",
        d.temperature || "",
        d.temperature_level || "",
        d.tds || "",
        d.tds_level || "",
        d.turbidity_ntu || "",
        d.turbidity_level || "",
        d.salinity || "",
        d.salinity_level || "",
        d.ph || "",
        d.ph_level || ""
      ]);
    });
    const csv = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "sensor_readings.csv";
    link.click();
  }
</script>

</body>
</html>
