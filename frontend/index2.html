<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oyster AI Dashboard</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      font-family: 'Inter', sans-serif;
      color: white;
      overflow-x: hidden;
    }
    main {
      width: 100%;
      max-width: 1200px;
      margin: auto;
      padding: 16px;
    }
    canvas {
      width: 100% !important;
      height: auto !important;
      max-height: 400px;
    }
    #live-cards {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 20px;
    }
    .card {
      flex: 1 1 calc(45% - 16px);
      max-width: 180px;
      min-width: 140px;
      height: 140px;
      background: rgba(30, 41, 59, 0.85);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 6px 25px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border-radius: 1rem;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .card:hover {
      transform: scale(1.08);
      box-shadow: 0 8px 35px rgba(255,255,255,0.2);
    }
    @media (max-width: 700px) {
      .card {
        flex: 1 1 100%;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="flex justify-between items-center px-6 py-4 bg-gray-900 bg-opacity-70 backdrop-blur-md sticky top-0 z-50 w-full">
    <h1 class="text-xl sm:text-2xl font-extrabold bg-gradient-to-r from-purple-400 via-pink-400 to-red-400 bg-clip-text text-transparent">
      Oyster AI Dashboard
    </h1>

    <!-- Hamburger -->
    <div class="relative">
      <button id="menu-btn" class="text-white focus:outline-none">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none"
             viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <div id="menu" class="hidden absolute right-0 mt-2 w-64 bg-gray-800 rounded-lg shadow-lg border border-gray-700">
        <a href="index.html" class="block px-4 py-2 hover:bg-gray-700">üìä Dashboard</a>
        <a href="statistics.html" class="block px-4 py-2 hover:bg-gray-700">üìà Statistics</a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main>
    <!-- Line Chart -->
    <div class="bg-gray-800 rounded-3xl shadow-2xl p-6 mb-8 border border-gray-700">
      <canvas id="lineChart"></canvas>
    </div>

    <!-- Live Cards -->
    <div id="live-cards"></div>
    <p id="last-updated" class="text-center text-sm text-gray-400 mt-4">‚è± Last updated: --</p>
  </main>

<script>
  // Toggle Menu
  const menuBtn = document.getElementById("menu-btn");
  const menu = document.getElementById("menu");
  menuBtn.addEventListener("click", () => menu.classList.toggle("hidden"));

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyCjTkCAgC8l9PUiFIeWXpy2S2nH7foJHX8",
    authDomain: "trial-reading.firebaseapp.com",
    databaseURL: "https://trial-reading-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "trial-reading",
    storageBucket: "trial-reading.firebasestorage.app",
    messagingSenderId: "541548808372",
    appId: "1:541548808372:web:773b8f8cac50b0e4c2afe1"
  };
  firebase.initializeApp(firebaseConfig);
  const dbRef = firebase.database().ref("trial1_Reading");

  // Chart.js Setup
  const ctx = document.getElementById('lineChart').getContext('2d');
  const lineChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: "üå° Temp", data: [], borderColor: "#f87171", tension: 0.5 },
        { label: "üíß TDS", data: [], borderColor: "#34d399", tension: 0.5 },
        { label: "üåä Turbidity", data: [], borderColor: "#fbbf24", tension: 0.5 },
        { label: "üßÇ Salinity", data: [], borderColor: "#60a5fa", tension: 0.5 },
        { label: "‚öóÔ∏è pH", data: [], borderColor: "#a78bfa", tension: 0.5 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: {
        duration: 1500,
        easing: "easeInOutCubic"
      },
      plugins: { 
        legend: { labels: { color: "#fff" } } 
      },
      scales: {
        x: { ticks: { color: "#9ca3af" } },
        y: { 
          ticks: { color: "#9ca3af", stepSize: 50 },
          min: 0,
          max: 1200
        }
      }
    }
  });

  // === Save chart state to localStorage ===
  function saveChartState() {
    const chartState = {
      labels: lineChart.data.labels,
      datasets: lineChart.data.datasets.map(ds => ds.data)
    };
    localStorage.setItem('oysterChartData', JSON.stringify(chartState));
  }

  // === Load chart state from localStorage ===
  function loadChartState() {
    const saved = localStorage.getItem('oysterChartData');
    if (!saved) return;
    const chartState = JSON.parse(saved);

    lineChart.data.labels = chartState.labels;
    lineChart.data.datasets.forEach((ds, i) => {
      ds.data = chartState.datasets[i];
    });
    lineChart.update();
  }

  // Load state immediately on page load
  loadChartState();

  // === Live Cards Renderer ===
  function renderCards(latest) {
    const container = document.getElementById("live-cards");
    container.innerHTML = "";

    const cards = [
      { label: "üå° Temp (¬∞C)", value: latest.temperature },
      { label: "üíß TDS (PPM)", value: latest.tds },
      { label: "üåä Turbidity", value: latest.turbidity_ntu ?? latest.turbidity_voltage ?? latest.turbidity_raw },
      { label: "üßÇ Salinity (PPT)", value: latest.salinity },
      { label: "‚öóÔ∏è pH", value: latest.ph }
    ];

    cards.forEach(card => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <p class="text-sm text-gray-400 mb-2">${card.label}</p>
        <p class="text-2xl font-extrabold text-green-400">${card.value ?? "--"}</p>
      `;
      container.appendChild(div);
    });
  }

  // === Real-time Firebase Listener ===
  dbRef.orderByChild("timestamp").limitToLast(20).on("child_added", snapshot => {
    const d = snapshot.val();
    if (!d) return;

    // Add new data point
    lineChart.data.labels.push(d.timestamp);
    lineChart.data.datasets[0].data.push(d.temperature ?? 0);
    lineChart.data.datasets[1].data.push(d.tds ?? 0);
    lineChart.data.datasets[2].data.push(d.turbidity_ntu ?? d.turbidity_voltage ?? d.turbidity_raw ?? 0);
    lineChart.data.datasets[3].data.push(d.salinity ?? 0);
    lineChart.data.datasets[4].data.push(d.ph ?? 0);

    // LIMIT to last 20 points
    if (lineChart.data.labels.length > 20) {
      lineChart.data.labels.shift();
      lineChart.data.datasets.forEach(ds => ds.data.shift());
    }

    // Update chart smoothly
    lineChart.update('active');

    // Save latest state to localStorage
    saveChartState();

    // Update live cards + timestamp
    renderCards(d);
    document.getElementById("last-updated").textContent = "‚è± Last updated: " + d.timestamp;
  });

  // === Optional: Pause Firebase updates when tab is inactive ===
  document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
      dbRef.off(); // Stop updates to save resources
    } else {
      // Re-attach listener when active
      dbRef.orderByChild("timestamp").limitToLast(50).on("child_added", snapshot => {
        const d = snapshot.val();
        if (!d) return;

        lineChart.data.labels.push(d.timestamp);
        lineChart.data.datasets[0].data.push(d.temperature ?? 0);
        lineChart.data.datasets[1].data.push(d.tds ?? 0);
        lineChart.data.datasets[2].data.push(d.turbidity_ntu ?? d.turbidity_voltage ?? d.turbidity_raw ?? 0);
        lineChart.data.datasets[3].data.push(d.salinity ?? 0);
        lineChart.data.datasets[4].data.push(d.ph ?? 0);

        if (lineChart.data.labels.length > 20) {
          lineChart.data.labels.shift();
          lineChart.data.datasets.forEach(ds => ds.data.shift());
        }

        lineChart.update('active');
        saveChartState();
        renderCards(d);
        document.getElementById("last-updated").textContent = "‚è± Last updated: " + d.timestamp;
      });
    }
  });
</script>
</body>
</html>
